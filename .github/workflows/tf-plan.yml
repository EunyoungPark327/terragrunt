name: Terragrunt Plan

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-2
  TERRAGRUNT_VERSION: 0.55.2
  TERRAFORM_VERSION: 1.13.0

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.0

      - name: Terraform Format Check
        run: |
          echo "ðŸ” Checking Terraform/HCL formatting..."
          
          if ! terraform fmt -check -recursive; then
            echo ""
            echo "âŒ Formatting errors found!"
            echo "Run the following command locally to fix:"
            echo "  terraform fmt -recursive"
            exit 1
          fi
          
          echo "âœ… All files are properly formatted"

  plan:
    name: Terragrunt Plan
    runs-on: ubuntu-latest
    needs: format-check
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed directories
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          dir_names: true
          files: |
            live/**/*.hcl
            modules/**/*.tf

      - name: Check for changes
        id: check-changes
        run: |
          if [[ -z "${{ steps.changed-files.outputs.all_modified_files }}" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No Terraform/Terragrunt changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Terraform/Terragrunt changes detected:"
            echo "${{ steps.changed-files.outputs.all_modified_files }}"
          fi

      - name: Configure AWS credentials
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: autero1/action-terragrunt@v3
        with:
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup tfcmt
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: shmokmt/actions-setup-tfcmt@v2
        with:
          version: v4.11.0

      - name: Create tfcmt wrapper script
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cat > gha-tfwrapper.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          command=$1
          base_dir=$(git rev-parse --show-toplevel)
          target=${PWD#"$base_dir"/}
          
          if [ "$command" == "plan" ]; then
            tfcmt -var "target:${target}" plan -- terraform "$@"
          elif [ "$command" == "apply" ]; then
            tfcmt -var "target:${target}" apply -- terraform "$@"
          else
            terraform "$@"
          fi
          EOF
          
          chmod +x gha-tfwrapper.sh

      - name: Build terragrunt include directories
        if: steps.check-changes.outputs.has_changes == 'true'
        id: build-include
        run: |
          TF_INCLUDE=""
          
          for file in ${{ steps.changed-files.outputs.all_modified_files }}; do
            if [[ "$file" == live/* ]]; then
              dir=$(dirname "$file")
              while [[ "$dir" != "live" && "$dir" != "." ]]; do
                if [[ -f "$dir/terragrunt.hcl" ]]; then
                  TF_INCLUDE="$TF_INCLUDE --terragrunt-include-dir $dir"
                  break
                fi
                dir=$(dirname "$dir")
              done
            fi
          done
          
          TF_INCLUDE=$(echo "$TF_INCLUDE" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          
          echo "Include directories: $TF_INCLUDE"
          
          if [[ -z "$TF_INCLUDE" ]]; then
            echo "include_dirs=" >> $GITHUB_OUTPUT
          else
            echo "include_dirs=$TF_INCLUDE" >> $GITHUB_OUTPUT
          fi

      - name: Run Terragrunt Plan
        if: steps.check-changes.outputs.has_changes == 'true' && steps.build-include.outputs.include_dirs != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd live
          
          terragrunt run-all plan \
            --terragrunt-non-interactive \
            --terragrunt-parallelism 1 \
            ${{ steps.build-include.outputs.include_dirs }} \
            --terragrunt-tfpath $(pwd)/../gha-tfwrapper.sh

      - name: Generate Plan Summary
        if: github.event_name == 'push'
        run: |
          echo "## ðŸ“‹ Terragrunt Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changed-files.outputs.all_modified_files }}" | tr ' ' '\n' | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Target Directories" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.build-include.outputs.include_dirs }}" | tr ' ' '\n' | sed 's/--terragrunt-include-dir //g' | while read dir; do
            if [[ -n "$dir" ]]; then
              echo "- \`$dir\`" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "Go to [Actions â†’ Terragrunt Apply](${{ github.server_url }}/${{ github.repository }}/actions/workflows/terragrunt-apply.yml) to deploy." >> $GITHUB_STEP_SUMMARY

      - name: No Terraform changes detected
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "## âœ… No Terraform Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No Terraform/Terragrunt files were modified in this PR." >> $GITHUB_STEP_SUMMARY
          echo "Format check passed, but Plan was skipped." >> $GITHUB_STEP_SUMMARY