name: Terragrunt Plan

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-2
  TERRAGRUNT_VERSION: 0.55.2
  TERRAFORM_VERSION: 1.13.0

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          echo "üîç Checking Terraform/HCL formatting..."
          if ! terraform fmt -check -recursive; then
            echo ""
            echo "‚ùå Formatting errors found!"
            echo "Run the following command locally to fix:"
            echo "  terraform fmt -recursive"
            exit 1
          fi
          echo "‚úÖ All files are properly formatted"

  plan:
    name: Terragrunt Plan
    runs-on: ubuntu-latest
    needs: format-check
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed directories
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47 (pin)
        with:
          dir_names: true
          files: |
            live/**/*.hcl
            modules/**/*.tf

      - name: Configure AWS credentials
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: autero1/action-terragrunt@v3
        with:
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup tfcmt
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: shmokmt/actions-setup-tfcmt@v2
        with:
          version: v4.11.0

      - name: Run Terragrunt Plan
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cd live
          TF_INCLUDE=""

          for dir in ${{ steps.changed-files.outputs.all_modified_files }}; do
            if [[ "$dir" != live/* ]]; then
              continue
            fi

            candidate="$dir"

            while [[ "$candidate" != "live" && "$candidate" != "." ]]; do
              if [[ -f "$candidate/terragrunt.hcl" ]]; then
                TF_INCLUDE="$TF_INCLUDE --terragrunt-include-dir $candidate"
                break
              fi
              candidate="$(dirname "$candidate")"
            done
          done

          TF_INCLUDE="$(echo "$TF_INCLUDE" | tr ' ' '\n' | sort -u | tr '\n' ' ')"
          echo "Include directories: $TF_INCLUDE"

          if [[ -z "$TF_INCLUDE" ]]; then
            echo "No live/* dirs with terragrunt.hcl changed. Skipping terragrunt run-all."
            exit 0
          fi

          terragrunt run-all plan \
            --terragrunt-non-interactive \
            $TF_INCLUDE \
            --terragrunt-tfpath "$(pwd)/../gha-tfwrapper.sh"
